# This is an auto generated Dockerfile for ros:ros-base
# generated from docker_images_ros2/create_ros_image.Dockerfile.em
FROM ros:humble-ros-core-jammy

# Avoid interactive prompts
# ENV DEBIAN_FRONTEND=noninteractive
ENV ROS_WS=/ros2_ws
ENV BASE_WS=/opt/ros_ws_base

# install bootstrap tools
RUN apt-get update && apt-get install --no-install-recommends -y \
    build-essential \
    cmake \
    git \
    libssl-dev \
    zlib1g-dev \
    python3-colcon-common-extensions \
    python3-colcon-mixin \
    python3-rosdep \
    python3-vcstool \
    python3-pip \
    software-properties-common \
    # X server related
    x11-apps \ 
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxcb-xinerama0 \
    libxcb-render0 \
    libxcb-shape0 \
    libxcb-icccm4 \
    libxkbcommon-x11-0 \
    libxrender1 \
    mesa-utils \
    # network tools
    iproute2 \
    tcpdump \
    iputils-ping \
    # libopenigtlink-dev \
    && rm -rf /var/lib/apt/lists/*

# bootstrap rosdep
RUN rosdep init && \
  rosdep update --rosdistro $ROS_DISTRO

# setup colcon mixin and metadata
RUN colcon mixin add default \
      https://raw.githubusercontent.com/colcon/colcon-mixin-repository/master/index.yaml && \
    colcon mixin update && \
    colcon metadata add default \
      https://raw.githubusercontent.com/colcon/colcon-metadata-repository/master/index.yaml && \
    colcon metadata update

# install ros2 packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-humble-ros-base=0.10.0-1* \
    '~nros-humble-rqt*' \
    ros-humble-tf2 \
    ros-humble-tf2-ros \
    ros-humble-tf2-geometry-msgs \
    ros-humble-geometry-msgs \
    ros-humble-sensor-msgs \
    && rm -rf /var/lib/apt/lists/*

# install python packages
RUN pip3 install --no-cache-dir pyserial

# get and build infrastructure source packages
WORKDIR /opt/igtl
RUN git clone https://github.com/openigtlink/OpenIGTLink.git
WORKDIR /opt/igtl/OpenIGTLink-build
RUN cmake -DBUILD_SHARED_LIBS:BOOL=ON ../OpenIGTLink && \
    make -j$(nproc) && \
    make install

WORKDIR $BASE_WS/src
RUN git clone https://github.com/openigtlink/ros2_igtl_bridge
    # change default ip to avoid server socket creation failure
    # sed -i 's/127.0.0.1/0.0.0.0/' $BASE_WS/src/ros2_igtl_bridge/src/igtl_node.cpp && \
    # sed -i 's/192.168.2.21/0.0.0.0/' $BASE_WS/src/ros2_igtl_bridge/launch/bridge.launch.py
WORKDIR $BASE_WS
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && \
    rosdep install --from-paths src --ignore-src -y && \
    colcon build --cmake-args -DOpenIGTLink_DIR:PATH=/opt/igtl/OpenIGTLink-build"

# build overlay
# WORKDIR $ROS_WS
# RUN /bin/bash -c "source /opt/ros_ws_base/install/setup.bash && \
#     find src/control_interface/control_interface_py -type f -name "*.py" ! -name "__init__.py" -exec chmod +x {} + && \
#     colcon build --symlink-install"

# add automatic ROS2 sourcing for interactive shells
RUN echo "source /opt/ros/humble/setup.bash" >> /root/.bashrc && \
    echo "source /opt/ros_ws_base/install/setup.bash" >> /root/.bashrc && \
    echo "source /ros2_ws/install/setup.bash" >> /root/.bashrc && \
    echo "export CMAKE_PREFIX_PATH=/usr/local:$CMAKE_PREFIX_PATH" >> /root/.bashrc && \
    echo "/usr/local/lib/igtl" > /etc/ld.so.conf.d/openigtlink.conf && ldconfig && \
    echo "export QT_X11_NO_MITSHM=1" >> /root/.bashrc && \
    echo "export QT_X11_NO_MITSHM=1" >> /root/.bashrc && \
    echo "export QT_QPA_PLATFORM=xcb" >> /root/.bashrc && \
    echo "export DISPLAY=host.docker.internal:0" >> /root/.bashrc